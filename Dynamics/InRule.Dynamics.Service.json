{
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "appServiceName": {
      "type": "string",
      "metadata": {
        "description": "Name of the App Service to deploy that the Rule Execution Service will be installed on"
      }
    },
    "relayName": {
      "type": "string",
      "metadata": {
        "description": "Name of the Azure Relay to deploy that will function as the service bus between the Rule Execution Service and Dynamics"
      }
    },
    "orgUrl": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Organization URL for the Dynamics instance used with the integration framework. This is just the root URL, ex: 'https://contoso.crm.dynamics.com'"
      }
    },
    "appId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Azure app ID used for S2S authentication"
      }
    },
    "appSecret": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "Secret value for app key used for S2S authentication"
      }
    },
    "crmConnectionString": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "Connection string for the Dynamics CRM instance used with the integration framework. Refer to this link for more details and formatting: https://docs.microsoft.com/en-us/dynamics365/customer-engagement/developer/xrm-tooling/use-connection-strings-xrm-tooling-connect"
      }
    },
    "catalogUri": {
      "type": "string",
      "metadata": {
        "description": "URI for your InRule Rule Catalog service, should follow this format: https://{Context}/Service.svc, with {Context} being replaced with the base catalog service URI."
      }
    },
    "catalogUser": {
      "type": "string",
      "metadata": {
        "description": "Login username to connect to your InRule Rule Catalog"
      }
    },
    "catalogPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Login password to connect to your InRule Rule Catalog"
      }
    },
    "createOrUpdateAppServicePlan": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "If set to false, provide the name and resource group of an existing service plan in the 'appServicePlanName' and 'servicePlanResourceGroupName' parameters. Otherwise a new plan will be created with the supplied name"
      }
    },
    "appServicePlanName": {
      "type": "string",
      "defaultValue": "[concat(parameters('appServiceName'),'Plan')]",
      "metadata": {
        "description": "Defines the App Service Plan's name, defaulting to the value of the App Service's name with 'Plan' appended to the end"
      }
    },
    "appServicePlanSkuName": {
      "type": "string",
      "defaultValue": "B1",
      "allowedValues": [
        "F1",
        "D1",
        "B1",
        "B2",
        "B3",
        "S1",
        "S2",
        "S3",
        "P1",
        "P2",
        "P3",
        "P4"
      ],
      "metadata": {
        "description": "Describes plan's pricing tier and capacity. Check details at https://azure.microsoft.com/en-us/pricing/details/app-service/"
      }
    },
    "servicePlanResourceGroupName": {
      "type": "string",
      "defaultValue": "[resourceGroup().name]",
      "metadata": {
        "description": "Optional name of the resource group for the existing app service plan. If creating a new plan, leave as the default value"
      }
    },
    "inRuleVersion": {
      "type": "string",
      "defaultValue": "5.6.0",
      "metadata": {
        "description": "Defines what version of the InRule Execution Service to deploy"
      }
    },
    "createOrUpdateAppInsightsResource": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "If set to true, provide a value for the appInsightsResourceName parameter. If set to false, you can provide a value for the appInsightsIntrumentationKey to associate your App Service with an existing App Insights resource"
      }
    },
    "appInsightsInstrumentationKey": {
      "type": "string",
      "defaultValue": "AppInsightsInstrumentationKey",
      "metadata": {
        "description": "If createOrUpdateAppInsightsResource is set to false and you have an existing App Insights resource you'd like to use instead, provide the Instrumentation key here. If createOrUpdateAppInsightsResource is set to true, leave this blank and provide a value for 'appInsightsResourceName' instead"
      }
    },
    "appInsightsResourceName": {
      "type": "string",
      "defaultValue": "[concat(parameters('appServiceName'),'AppInsights')]",
      "metadata": {
        "description": "If createOrUpdateAppInsightsResource is set to true, define the name of the Application Insights resource to deploy here. If createOrUpdateAppInsightsResource is set to false, leave this field blank"
      }
    },
    "appInsightsLocation": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Defines what Azure region to deploy the Application Insights resource to. Check details at https://azure.microsoft.com/en-us/global-infrastructure/services/?products=monitor"
      }
    },
    "packageUri": {
      "type": "string",
      "defaultValue": "[concat('https://github.com/InRule/AzureAppServices/releases/download/v', parameters('inRuleVersion'),'/InRule.CRM.WebJob.zip')]",
      "metadata": {
        "description": "Download URI for the Execution Service package. Calculated from the inRuleVersion parameter."
      }
    }
  },
  "variables": {
    "appServicePlanName": "[if(empty(parameters('appServicePlanName')), concat(parameters('appServiceName'),'Plan'), parameters('appServicePlanName'))]",
    "appInsightsResourceName": "[if(empty(parameters('appInsightsResourceName')), concat(parameters('appServiceName'),'Insights'), parameters('appInsightsResourceName'))]"
  },
  "resources": [
    {
      "name": "[parameters('relayName')]",
      "type": "Microsoft.Relay/namespaces",
      "apiVersion": "2017-04-01",
      "location": "[resourceGroup().location]",
      "properties": {}
    },
    {
      "condition": "[parameters('createOrUpdateAppInsightsResource')]",
      "name": "[variables('appInsightsResourceName')]",
      "type": "Microsoft.Insights/components",
      "apiVersion": "2015-05-01",
      "location": "[parameters('appInsightsLocation')]",
      "dependsOn": [
        "[concat('Microsoft.Relay/namespaces/', parameters('relayName'))]"
      ],
      "kind": "web",
      "tags": {
        "[concat('hidden-link:', resourceGroup().id, '/providers/Microsoft.Web/sites/', parameters('appInsightsResourceName'))]": "Resource"
      },
      "properties": {}
    },
    {
      "condition": "[parameters('createOrUpdateAppServicePlan')]",
      "name": "AppServicePlanTemplate",
      "apiVersion": "2017-05-10",
      "type": "Microsoft.Resources/deployments",
      "resourceGroup": "[parameters('servicePlanResourceGroupName')]",
      "dependsOn": [
        "[concat('Microsoft.Relay/namespaces/', parameters('relayName'))]"
      ],
      "properties": {
        "mode": "Incremental",
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "resources": [
            {
              "name": "[variables('appServicePlanName')]",
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2016-09-01",
              "location": "[resourceGroup().location]",
              "properties": {
                "name": "[variables('appServicePlanName')]"
              },
              "sku": {
                "name": "[parameters('appServicePlanSkuName')]"
              }
            }
          ]
        }
      }
    },
    {
      "name": "[parameters('appServiceName')]",
      "type": "Microsoft.Web/sites",
      "apiVersion": "2016-08-01",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[resourceId(parameters('servicePlanResourceGroupName'), 'Microsoft.Resources/deployments', 'AppServicePlanTemplate')]",
        "[concat('Microsoft.Relay/namespaces/', parameters('relayName'))]"
      ],
      "properties": {
        "serverFarmId": "[resourceId(parameters('servicePlanResourceGroupName'), 'Microsoft.Web/serverfarms', variables('appServicePlanName'))]",
        "siteConfig": {
          "AlwaysOn": true,
          "use32BitWorkerProcess": false
        }
      },
      "resources": [
        {
          "name": "MSDeploy",
          "type": "extensions",
          "apiVersion": "2016-08-01",
          "dependsOn": [
            "[concat('Microsoft.Web/sites/', parameters('appServiceName'))]"
          ],
          "properties": {
            "packageUri": "[parameters('packageURI')]"
          }
        },
        {
          "name": "appsettings",
          "type": "config",
          "apiVersion": "2016-08-01",
          "dependsOn": [
            "[concat('Microsoft.Web/Sites/', parameters('appServiceName'), '/Extensions/MSDeploy')]",
            "[concat('Microsoft.Web/sites/', parameters('appServiceName'))]"
          ],
          "properties": {
            "inrule:crm:catalog:label": "LIVE",
            "inrule:crm:catalog:user": "[parameters('catalogUser')]",
            "inrule:crm:catalog:password": "[parameters('catalogPassword')]",
            "inrule:crm:catalog:sso": "false",
            "inrule:crm:catalog:uri": "[parameters('catalogUri')]",
            "inrule:crm:catalog:ruleAppDirectory": "C:\\RuleApps",
            "inrule:crm:catalog:useInRuleCatalog": "true",
            "inrule:crm:serviceBus:key": "[listKeys(resourceId('Microsoft.Relay/namespaces/authorizationRules', parameters('relayName'), 'RootManageSharedAccessKey'), '2017-04-01').primaryKey]",
            "inrule:crm:serviceBus:namespace": "[parameters('relayName')]",
            "inrule:crm:serviceBus:owner": "RootManageSharedAccessKey",
            "inrule:crm:serviceBus:path": "ruleexecution",
            "inrule:crm:s2s:azureAppId": "[parameters('appId')]",
            "inrule:crm:s2s:azureAppSecret": "[parameters('appSecret')]",
            "inrule:crm:s2s:crmOrgUrl": "[parameters('orgUrl')]",
            "inrule:repository:licensing:licenseFolder": "D:\\home\\site\\wwwroot",
            "inrule:logging:level": "Warn",
            "inrule:logging:appInsights:instrumentationKey": "[if(empty(parameters('appInsightsResourceName')), parameters('appInsightsInstrumentationKey'), reference(resourceId('Microsoft.Insights/components', parameters('appInsightsResourceName'))).InstrumentationKey)]"
          }
        },
        {
          "condition": "[not(equals(parameters('crmConnectionString'), ''))]",
          "name": "connectionstrings",
          "type": "config",
          "apiVersion": "2016-08-01",
          "dependsOn": [
            "[concat('Microsoft.Web/Sites/', parameters('appServiceName'), '/Extensions/MSDeploy')]",
            "[concat('Microsoft.Web/sites/', parameters('appServiceName'))]"
          ],
          "properties": {
            "DynamicsCRM": {
              "value": "[parameters('crmConnectionString')]",
              "type": "Custom"
            }
          }
        }
      ]
    }
  ],
  "outputs": {
    "relayKey": {
      "type": "string",
      "value": "[listKeys(resourceId('Microsoft.Relay/namespaces/authorizationRules', parameters('relayName'), 'RootManageSharedAccessKey'), '2017-04-01').primaryKey]"
    }    
  }
}
